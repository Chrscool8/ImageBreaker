   import java.awt.image.BufferedImage;
   import java.io.IOException;
   import javax.imageio.ImageIO;
   import javax.swing.JOptionPane;
   import java.io.*;
   import java.util.*;

/**
 * 
 * @author Allen - Also messed with by Chris
 *
 */
   public class ImageSlicer {
      BufferedImage img;
      String[] fileInfo;
   
      public ImageSlicer(BufferedImage i, String filename){
         img = i;
         fileInfo = filename.split("\\.");
      }
   
   /**
    * Breaks the given image up and saves the sub images to the user's desktop.
    * @param width Width of Subimages
    * @param height Height of Subimages
    */
      public void slice(int width, int height){		
         int x = img.getWidth()/width;
         int y = img.getHeight()/height;
      
         if(x == 0 && y == 0){
            infoBox("SubImages are larger than original!", "Error");
            System.exit(2);
         }
         if (img.getWidth()%width > 0){
            ++x;
         }
         if (img.getHeight()%height > 0){
            ++y;
         }
      	
         int count = 1;    
      
         BufferedImage[][] images = new BufferedImage[x][y];
         File outputfile = null;
         for (int j = 0; j < y; ++j){
            for (int i = 0; i < x; ++i){
               int w = width;
               int h = height;
               if (i+1 == x && img.getWidth()%width != 0){
                  w = img.getWidth()%width;					
               }
               if (j+1 == y && img.getHeight()%height != 0){
                  h = img.getHeight()%height;			
               }
            
               images[i][j] = img.getSubimage(i*width,j*height, w, h);
            
               try {		
               //This will save to where the JAR is saved, in the folder "output".
                  String stupidlongthing = ClassLoader.getSystemClassLoader().getResource(".").getPath().replaceAll("%20", " ")+"\\output\\sprites\\images\\spr_"+fileInfo[0]+"_"+i+"_"+j+"."+fileInfo[fileInfo.length-1];
                  stupidlongthing = stupidlongthing.replaceAll("file:/", "").replaceAll("ImageBreaker.jar\\!", "");      
               	
                  outputfile = new File(stupidlongthing);
               
                  System.out.println(count+"/"+(x*y));
                  count++;
                  File directory = outputfile.getParentFile();
                  directory.mkdirs();
                  
                  ImageIO.write(images[i][j], fileInfo[fileInfo.length-1], outputfile);//Returns true if save succesful			    
               	
               } 
                  catch (IOException e) {
                     //infoBox("Save failed!", "Error");
                  }
            		
            		//sprite.gmx files!?
               try {
                  BufferedWriter out = new BufferedWriter(new FileWriter("output\\sprites\\spr_"+fileInfo[0]+"_"+i+"_"+j+".sprite.gmx"));
                  out.write("<!--This Document is generated by GameMaker, if you edit it by hand then you do so at your own risk!-->"); out.newLine();
                  out.write("<sprite>"); out.newLine();
                  out.write("  <xorig>0</xorig>"); out.newLine();
                  out.write("  <yorigin>0</yorigin>"); out.newLine();
                  out.write("  <colkind>0</colkind>"); out.newLine();
                  out.write("  <coltolerance>0</coltolerance>"); out.newLine();
                  out.write("  <sepmasks>-1</sepmasks>"); out.newLine();
                  out.write("  <bboxmode>0</bboxmode>"); out.newLine();
                  out.write("  <bbox_left>0</bbox_left>"); out.newLine();
                  out.write("  <bbox_right>1023</bbox_right>"); out.newLine();
                  out.write("  <bbox_top>0</bbox_top>"); out.newLine();
                  out.write("  <bbox_bottom>1023</bbox_bottom>"); out.newLine();
                  out.write("  <HTile>0</HTile>"); out.newLine();
                  out.write("  <VTile>0</VTile>"); out.newLine();
                  out.write("  <TextureGroup>0</TextureGroup>"); out.newLine();
                  out.write("  <For3D>0</For3D>"); out.newLine();
                  out.write("  <frames>"); out.newLine();
                  out.write("    <frame index=\"0\">images\\spr_"+fileInfo[0]+"_"+i+"_"+j+"."+fileInfo[fileInfo.length-1]+"</frame>"); out.newLine();
                  out.write("  </frames>"); out.newLine();
                  out.write("</sprite>"); out.newLine();
                  out.close();
               	
               	//Sweet, now time to make fake... well, artificially created objects. Like test tube babies. Still real, just different.
               	
                  BufferedWriter out2 = new BufferedWriter(new FileWriter("output\\objects\\obj_"+fileInfo[0]+"_"+i+"_"+j+".object.gmx"));
                  out2.write("<!--This Document is generated by GameMaker, if you edit it by hand then you do so at your own risk!-->"); out2.newLine();
                  out2.write("<object>"); out2.newLine();
                  out2.write("  <spriteName>spr_"+fileInfo[0]+"_"+i+"_"+j+"</spriteName>"); out2.newLine();
                  out2.write("  <solid>0</solid>"); out2.newLine();
                  out2.write("  <visible>-1</visible>"); out2.newLine();
                  out2.write("  <depth>0</depth>"); out2.newLine();
                  out2.write("  <persistent>0</persistent>"); out2.newLine();
                  out2.write("  <parentName>obj_scenery</parentName>"); out2.newLine();
                  out2.write("  <maskName>&lt;undefined&gt;</maskName>"); out2.newLine();
                  out2.write("  <events/>"); out2.newLine();
                  out2.write("  <PhysicsObject>0</PhysicsObject>"); out2.newLine();
                  out2.write("  <PhysicsObjectSensor>0</PhysicsObjectSensor>"); out2.newLine();
                  out2.write("  <PhysicsObjectShape>1</PhysicsObjectShape>"); out2.newLine();
                  out2.write("  <PhysicsObjectDensity>0</PhysicsObjectDensity>"); out2.newLine();
                  out2.write("  <PhysicsObjectRestitution>0.100000001490116</PhysicsObjectRestitution>"); out2.newLine();
                  out2.write("  <PhysicsObjectGroup>2</PhysicsObjectGroup>"); out2.newLine();
                  out2.write("  <PhysicsObjectLinearDamping>0.100000001490116</PhysicsObjectLinearDamping>"); out2.newLine();
                  out2.write("  <PhysicsObjectAngularDamping>0.100000001490116</PhysicsObjectAngularDamping>"); out2.newLine();
                  out2.write("  <PhysicsShapePoints>"); out2.newLine();
                  out2.write("    <point>0,0</point>"); out2.newLine();
                  out2.write("    <point>64,0</point>"); out2.newLine();
                  out2.write("    <point>64,64</point>"); out2.newLine();
                  out2.write("    <point>0,64</point>"); out2.newLine();
                  out2.write("  </PhysicsShapePoints>"); out2.newLine();
                  out2.write("</object>"); out2.newLine();
               
                  out2.close();
               	
               }
                  catch (IOException e)
                  {
                     System.out.println(e);       
                  }
            }
         }
         
         System.out.println("Saving completed.");
      }
   
      private void infoBox(String infoMessage, String title)
      {
         JOptionPane.showMessageDialog(null, infoMessage, title, JOptionPane.INFORMATION_MESSAGE);
      }
   }
